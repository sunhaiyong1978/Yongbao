From 61bb5f03d8ee74e739c08626e68c36ab567d7380 Mon Sep 17 00:00:00 2001
From: Sun Haiyong <sunhaiyong@zdbr.net>
Date: Sat, 6 Sep 2025 03:28:13 +0000
Subject: [PATCH 9/9] Chromium 140 build ffmpeg scripts add loongarch64

---
 media/ffmpeg/scripts/build_ffmpeg.py    | 24 +++++++++++++++++---
 media/ffmpeg/scripts/generate_gn.py     |  2 +-
 media/ffmpeg/scripts/robo_lib/config.py | 30 +++++--------------------
 3 files changed, 28 insertions(+), 28 deletions(-)

diff --git a/media/ffmpeg/scripts/build_ffmpeg.py b/media/ffmpeg/scripts/build_ffmpeg.py
index 9ef6ba9afc..b97e205a7a 100755
--- a/media/ffmpeg/scripts/build_ffmpeg.py
+++ b/media/ffmpeg/scripts/build_ffmpeg.py
@@ -42,7 +42,7 @@ BRANDINGS = [
 
 ARCH_MAP = {
     'android': ['ia32', 'x64', 'arm-neon', 'arm64'],
-    'linux': ['ia32', 'x64', 'noasm-x64', 'arm', 'arm-neon', 'arm64', 'riscv64'],
+    'linux': ['ia32', 'x64', 'noasm-x64', 'arm', 'arm-neon', 'arm64', 'riscv64', 'loong64'],
     'mac': ['x64', 'arm64'],
     'win': ['ia32', 'x64', 'arm64'],
 }
@@ -725,10 +725,13 @@ def ConfigureAndBuild(target_arch, target_os, host_os, host_arch,
                     '--target-os=linux',
                 ])
 
-                if host_arch != 'x64':
+                if host_arch != '':
                     configure_flags['Common'].extend([
                         '--enable-cross-compile',
-                        '--cross-prefix=/usr/bin/x86_64-linux-gnu-',
+                        '--sysroot=' + os.path.join(
+                            CHROMIUM_ROOT_DIR,
+                            'build/linux/debian_bullseye_amd64-sysroot'),
+#                        '--cross-prefix=/usr/bin/x86_64-linux-gnu-',
                         '--extra-cflags=--target=x86_64-linux-gnu',
                         '--extra-ldflags=--target=x86_64-linux-gnu',
                     ])
@@ -911,6 +914,21 @@ def ConfigureAndBuild(target_arch, target_os, host_os, host_arch,
                     '--extra-cflags=--target=riscv64-linux-gnu',
                     '--extra-ldflags=--target=riscv64-linux-gnu',
                 ])
+        elif target_arch == 'loong64':
+            # These flags taken from android chrome build with target_cpu='mips64el'
+            configure_flags['Common'].extend([
+                '--arch=loongarch64',
+            ])
+            if target_os == 'linux':
+                configure_flags['Common'].extend([
+                    '--enable-cross-compile',
+                    '--target-os=linux',
+                    '--sysroot=' + os.path.join(
+                        CHROMIUM_ROOT_DIR,
+                        'build/linux/loongarch64-sysroot'),
+                    '--extra-cflags=--target=loongarch64-unknown-linux-gnu',
+                    '--extra-ldflags=--target=loongarch64-unknown-linux-gnu',
+                ])
         else:
             print('Error: Unknown target arch %r for target OS %r!' %
                   (target_arch, target_os),
diff --git a/media/ffmpeg/scripts/generate_gn.py b/media/ffmpeg/scripts/generate_gn.py
index a3349aca97..fff7d32966 100755
--- a/media/ffmpeg/scripts/generate_gn.py
+++ b/media/ffmpeg/scripts/generate_gn.py
@@ -78,7 +78,7 @@ GN_SOURCE_END = """]
 _Attrs = ('ARCHITECTURE', 'TARGET', 'PLATFORM')
 Attr = collections.namedtuple('Attr', _Attrs)(*_Attrs)
 SUPPORT_MATRIX = {
-    Attr.ARCHITECTURE: set(['ia32', 'x64', 'arm', 'arm64', 'arm-neon', 'riscv64']),
+    Attr.ARCHITECTURE: set(['ia32', 'x64', 'arm', 'arm64', 'arm-neon', 'riscv64', 'loong64']),
     Attr.TARGET: set(['Chromium', 'Chrome']),
     Attr.PLATFORM: set(['android', 'linux', 'win', 'mac'])
 }
diff --git a/media/ffmpeg/scripts/robo_lib/config.py b/media/ffmpeg/scripts/robo_lib/config.py
index 685d0f5419..fb851e25ee 100644
--- a/media/ffmpeg/scripts/robo_lib/config.py
+++ b/media/ffmpeg/scripts/robo_lib/config.py
@@ -56,8 +56,8 @@ class RoboConfiguration:
         self._llvm_path = os.path.join(self.chrome_src(), "third_party",
                                        "llvm-build", "Release+Asserts", "bin")
 
-        self.EnsurePathContainsLLVM()
-        self.EnsureNoMakeInfo()
+#        self.EnsurePathContainsLLVM()
+#        self.EnsureNoMakeInfo()
         self.EnsureFFmpegHome()
         self.EnsureGNConfig()
         self.ComputeBranchName()
@@ -195,6 +195,8 @@ class RoboConfiguration:
             self._host_architecture = "mipsel"
         elif platform.machine() == "mips64":
             self._host_architecture = "mips64el"
+        elif platform.machine() == "loongarch64":
+            self._host_architecture = "loong64"
         elif platform.machine().startswith("arm"):
             self._host_architecture = "arm"
         elif platform.machine() == "riscv64":
@@ -205,26 +207,6 @@ class RoboConfiguration:
 
         if platform.system() == "Linux":
             self._host_operating_system = "linux"
-
-            for release_file in ("/etc/lsb-release", "/etc/os-release"):
-                try:
-                    with open(release_file, "r") as f:
-                        result = f.read()
-                        if "Ubuntu" in result or "Debian" in result:
-                            self._os_flavor = packages.OsFlavor.Debian
-                        elif "Arch" in result:
-                            self._os_flavor = packages.OsFlavor.Arch
-                        else:
-                            raise Exception(
-                                "Couldn't determine OS flavor from lsb-release "
-                                "(needed to install packages)")
-                        break
-                except:
-                    pass
-            else:
-                raise Exception(
-                    "Couldn't read OS flavor from /etc/{os,lsb}-release file "
-                    "(needed to install packages)")
         elif platform.system() == "Darwin":
             self._host_operating_system = "mac"
         elif platform.system() == "Windows" or "CYGWIN_NT" in platform.system(
@@ -238,8 +220,8 @@ class RoboConfiguration:
         wd = os.getcwd()
         # Walk up the tree until we find src/AUTHORS
         while wd != "/":
-            if os.path.isfile(os.path.join(wd, "src", "AUTHORS")):
-                self._chrome_src = os.path.join(wd, "src")
+            if os.path.isfile(os.path.join(wd, "AUTHORS")):
+                self._chrome_src = os.path.join(wd)
                 return
             wd = os.path.dirname(wd)
         raise Exception("could not find src/AUTHORS in any parent of the wd")
-- 
2.31.1

