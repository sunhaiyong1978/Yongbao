From 8158146f1d06f2167efbf580773ef79c5da3c6f7 Mon Sep 17 00:00:00 2001
From: Sun Haiyong <sunhaiyong@zdbr.net>
Date: Tue, 10 Oct 2023 15:01:35 +0000
Subject: [PATCH] firefox 118 fix for python3.12

---
 netwerk/dns/prepare_tlds.py          |  1 -
 python/mach/mach/command_util.py     | 19 ++++++++++++++++---
 python/mozbuild/mozbuild/nodeutil.py |  1 +
 3 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/netwerk/dns/prepare_tlds.py b/netwerk/dns/prepare_tlds.py
index 53d0bf526d..86f5b0fb2b 100644
--- a/netwerk/dns/prepare_tlds.py
+++ b/netwerk/dns/prepare_tlds.py
@@ -4,7 +4,6 @@
 
 import codecs
 import encodings.idna
-import imp
 import os
 import re
 import sys
diff --git a/python/mach/mach/command_util.py b/python/mach/mach/command_util.py
index f7840ebfbe..8ae80a5cc8 100644
--- a/python/mach/mach/command_util.py
+++ b/python/mach/mach/command_util.py
@@ -5,7 +5,7 @@
 import argparse
 import ast
 import errno
-import imp
+import types
 import sys
 import uuid
 from collections.abc import Iterable
@@ -403,6 +403,19 @@ def load_commands_from_directory(path: Path):
         load_commands_from_file(full_path, module_name=module_name)
 
 
+import importlib.util
+import importlib.machinery
+
+def load_source(modname, filename):
+    loader = importlib.machinery.SourceFileLoader(modname, filename)
+    spec = importlib.util.spec_from_file_location(modname, filename, loader=loader)
+    module = importlib.util.module_from_spec(spec)
+    # The module is always executed and not cached in sys.modules.
+    # Uncomment the following line to cache the module.
+    # sys.modules[module.__name__] = module
+    loader.exec_module(module)
+    return module
+
 def load_commands_from_file(path: Union[str, Path], module_name=None):
     """Scan for mach commands from a file.
 
@@ -414,13 +427,13 @@ def load_commands_from_file(path: Union[str, Path], module_name=None):
         # Ensure parent module is present otherwise we'll (likely) get
         # an error due to unknown parent.
         if "mach.commands" not in sys.modules:
-            mod = imp.new_module("mach.commands")
+            mod = types.ModuleType("mach.commands")
             sys.modules["mach.commands"] = mod
 
         module_name = f"mach.commands.{uuid.uuid4().hex}"
 
     try:
-        imp.load_source(module_name, str(path))
+        load_source(module_name, str(path))
     except IOError as e:
         if e.errno != errno.ENOENT:
             raise
diff --git a/python/mozbuild/mozbuild/nodeutil.py b/python/mozbuild/mozbuild/nodeutil.py
index 8ec724ab89..809b05a43c 100644
--- a/python/mozbuild/mozbuild/nodeutil.py
+++ b/python/mozbuild/mozbuild/nodeutil.py
@@ -5,6 +5,7 @@
 import os
 import platform
 import subprocess
+import setuptools
 from distutils.version import StrictVersion
 
 from mozboot.util import get_tools_dir
-- 
2.31.1

