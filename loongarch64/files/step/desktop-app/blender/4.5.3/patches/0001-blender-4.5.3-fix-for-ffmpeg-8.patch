From 6e9f1b1fd069200e71f7e29ac17d2e831dc9fa9a Mon Sep 17 00:00:00 2001
From: Sun Haiyong <sunhaiyong@zdbr.net>
Date: Thu, 25 Sep 2025 11:57:11 +0000
Subject: [PATCH] blender 4.5.3 fix for ffmpeg 8.

---
 extern/audaspace/plugins/ffmpeg/FFMPEGReader.cpp       | 4 ++--
 source/blender/imbuf/movie/intern/movie_write_audio.cc | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/extern/audaspace/plugins/ffmpeg/FFMPEGReader.cpp b/extern/audaspace/plugins/ffmpeg/FFMPEGReader.cpp
index efe36df..c1758d8 100644
--- a/extern/audaspace/plugins/ffmpeg/FFMPEGReader.cpp
+++ b/extern/audaspace/plugins/ffmpeg/FFMPEGReader.cpp
@@ -285,9 +285,9 @@ FFMPEGReader::FFMPEGReader(std::shared_ptr<Buffer> buffer, int stream) :
 		m_membuffer(buffer),
 		m_membufferpos(0)
 {
-	m_membuf = reinterpret_cast<data_t*>(av_malloc(AV_INPUT_BUFFER_MIN_SIZE + AV_INPUT_BUFFER_PADDING_SIZE));
+	m_membuf = reinterpret_cast<data_t*>(av_malloc((256 * 1024) + AV_INPUT_BUFFER_PADDING_SIZE));
 
-	m_aviocontext = avio_alloc_context(m_membuf, AV_INPUT_BUFFER_MIN_SIZE, 0, this, read_packet, nullptr, seek_packet);
+	m_aviocontext = avio_alloc_context(m_membuf, (256 * 1024), 0, this, read_packet, nullptr, seek_packet);
 
 	if(!m_aviocontext)
 	{
diff --git a/source/blender/imbuf/movie/intern/movie_write_audio.cc b/source/blender/imbuf/movie/intern/movie_write_audio.cc
index 56746cf..e600e29 100644
--- a/source/blender/imbuf/movie/intern/movie_write_audio.cc
+++ b/source/blender/imbuf/movie/intern/movie_write_audio.cc
@@ -327,7 +327,7 @@ AVStream *alloc_audio_stream(MovieWriter *context,
     /* Used to be if ((c->codec_id >= CODEC_ID_PCM_S16LE) && (c->codec_id <= CODEC_ID_PCM_DVD))
      * not sure if that is needed anymore, so let's try out if there are any
      * complaints regarding some FFMPEG versions users might have. */
-    context->audio_input_samples = AV_INPUT_BUFFER_MIN_SIZE * 8 / c->bits_per_coded_sample /
+    context->audio_input_samples = (256 * 1024) * 8 / c->bits_per_coded_sample /
                                    audio_channels;
   }
   else {
-- 
2.31.1

